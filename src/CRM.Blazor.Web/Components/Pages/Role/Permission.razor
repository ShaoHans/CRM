@using Volo.Abp.PermissionManagement
@inject IPermissionAppService PermissionAppService

<RadzenTabs TabPosition="TabPosition.Left" RenderMode="TabRenderMode.Client">
    <Tabs>
        @foreach (var item in _groups)
        {
            <RadzenTabsItem Text="@item.DisplayName">
                <RadzenTree AllowCheckBoxes="true" Style="width: 100%; height: 100%"
                            Data=@(_permissionTrees.Where(x=>x.GroupName==item.Name))>
                    <RadzenTreeLevel TextProperty="@nameof(PermissionTreeItemVm.DisplayName)"
                                     ChildrenProperty="Children" 
                        Expanded="(i=>true)"
                        HasChildren="(i=>((PermissionTreeItemVm)i).Children.Count>0)" />
                </RadzenTree>
            </RadzenTabsItem>
        }
    </Tabs>
</RadzenTabs>

@code {
    string entityDisplayName;
    string _providerName = "R";
    string _providerKey = "admin";

    string _entityDisplayName;

    List<PermissionGroupDto> _groups = [];
    List<PermissionGrantInfoDto> _disabledPermissions = [];

    int _grantedPermissionCount = 0;
    int _notGrantedPermissionCount = 0;
    bool _selectAllDisabled;
    Dictionary<string, int> _permissionDepths = new Dictionary<string, int>();
    protected string _selectedTabName;
    List<PermissionTreeItemVm> _permissionTrees = [];

    protected bool GrantAll
    {
        get
        {
            if (_notGrantedPermissionCount == 0)
            {
                return true;
            }

            return false;
        }
        set
        {
            if (_groups == null)
            {
                return;
            }

            _grantedPermissionCount = 0;
            _notGrantedPermissionCount = 0;

            foreach (var permission in _groups.SelectMany(x => x.Permissions))
            {
                if (!IsDisabledPermission(permission))
                {
                    permission.IsGranted = value;

                    if (value)
                    {
                        _grantedPermissionCount++;
                    }
                    else
                    {
                        _notGrantedPermissionCount++;
                    }
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var result = await PermissionAppService.GetAsync(_providerName, _providerKey);

        _entityDisplayName = entityDisplayName ?? result.EntityDisplayName;
        _groups = result.Groups;

        _selectAllDisabled = _groups.All(IsPermissionGroupDisabled);

        _grantedPermissionCount = 0;
        _notGrantedPermissionCount = 0;
        foreach (var permission in _groups.SelectMany(x => x.Permissions))
        {
            if (permission.IsGranted && permission.GrantedProviders.All(x => x.ProviderName != _providerName))
            {
                _disabledPermissions.Add(permission);
                continue;
            }

            if (permission.IsGranted)
            {
                _grantedPermissionCount++;
            }
            else
            {
                _notGrantedPermissionCount++;
            }
        }

        _selectedTabName = GetNormalizedGroupName(_groups.First().Name);

        foreach (var group in _groups)
        {
            //SetPermissionDepths(group.Permissions, null, 0);
            _permissionTrees.AddRange(GenerateTree(group.Permissions, group.Name, null, 0));
        }
    }

    string GetNormalizedGroupName(string name)
    {
        return "PermissionGroup_" + name.Replace(".", "_");
    }

    bool IsPermissionGroupDisabled(PermissionGroupDto group)
    {
        var permissions = group.Permissions;
        var grantedProviders = permissions.SelectMany(x => x.GrantedProviders);

        return permissions.All(x => x.IsGranted) && grantedProviders.Any(p => p.ProviderName != _providerName);
    }

    void SetPermissionDepths(List<PermissionGrantInfoDto> permissions, string? currentParent, int currentDepth)
    {
        foreach (var item in permissions)
        {
            if (item.ParentName == currentParent)
            {
                _permissionDepths[item.Name] = currentDepth;
                SetPermissionDepths(permissions, item.Name, currentDepth + 1);
            }
        }
    }

    List<PermissionTreeItemVm> GenerateTree(List<PermissionGrantInfoDto> allPermissions, string groupName, string? parentName, int depth)
    {
        var treeItems = new List<PermissionTreeItemVm>();
        var subPermissions = allPermissions.Where(p => p.ParentName == parentName);

        foreach (var item in subPermissions)
        {
            treeItems.Add(new PermissionTreeItemVm(depth, groupName, item, GenerateTree(allPermissions, groupName, item.Name, depth + 1)));
        }
        return treeItems;
    }


    bool IsDisabledPermission(PermissionGrantInfoDto permissionGrantInfo)
    {
        return _disabledPermissions.Any(x => x == permissionGrantInfo);
    }
}