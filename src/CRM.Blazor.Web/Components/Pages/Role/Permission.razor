@using Volo.Abp.AspNetCore.Components.Web.Configuration
@using Volo.Abp.PermissionManagement
@inject IPermissionAppService PermissionAppService
@inject ICurrentApplicationConfigurationCacheResetService CacheResetService
@inject NotificationService NotificationService
@inject DialogService DialogService


<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
    <RadzenCheckBox TValue="bool" Name="GrantAll" />
    <RadzenLabel Text="授予所有权限" Component="GrantAll" />
</RadzenStack>
<RadzenStack Orientation="Orientation.Vertical" Gap="0" class="rz-pt-1"
             Style="border-top: var(--rz-grid-cell-border); min-height: 2rem; max-height: 12rem; overflow: auto;" />

<RadzenTabs TabPosition="TabPosition.Left" RenderMode="TabRenderMode.Client">
    <Tabs>
        @foreach (var item in _groups)
        {
            <RadzenTabsItem Text="@item.DisplayName">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                    <RadzenCheckBox TValue="bool" Name="@item.DisplayName" @bind-Value="@_selectAll" onclick="@(()=>SelectAll(item.Name))" />
                    <RadzenLabel Text="全选" Component="@item.DisplayName" />
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Vertical" Gap="0" class="rz-pt-1" 
                            Style="border-top: var(--rz-grid-cell-border); min-height: 2rem; max-height: 12rem; overflow: auto;" />

                <RadzenTree Style="width: 100%; height: 100%"
                            Data=@(_permissionTrees.Where(x=>x.GroupName==item.Name))>
                    <RadzenTreeLevel TextProperty="@nameof(PermissionTreeItemVm.DisplayName)"
                                     ChildrenProperty="Children"
                                     Expanded="(i=>true)"
                                     HasChildren="(i=>((PermissionTreeItemVm)i).Children.Count>0)">
                        <Template>
                            @{
                                var treeItem = (PermissionTreeItemVm)context.Value;
                                <RadzenCheckBox TValue="bool"
                                                Name="@treeItem.Name"
                                                onclick="@(()=>PermissionCheckChanged(context.Value))"
                                                @bind-Value="treeItem.IsGranted" />
                                <RadzenLabel Text="@context.Text" Component="@treeItem.Name" />
                            }
                        </Template>
                    </RadzenTreeLevel>
                </RadzenTree>
            </RadzenTabsItem>
        }
    </Tabs>
</RadzenTabs>

<RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="0.5rem" class="rz-pt-4 rz-pb-8">
    <RadzenButton Icon="save" Click="SaveAsync">保存</RadzenButton>
</RadzenStack>

@code {
    [Parameter]
    public string ProviderName { get; set; } = default!;
    [Parameter]
    public string ProviderKey { get; set; } = default!;

    List<PermissionGroupDto> _groups = [];
    List<PermissionGrantInfoDto> _disabledPermissions = [];

    int _grantedPermissionCount = 0;
    int _notGrantedPermissionCount = 0;
    bool _selectAllDisabled;
    bool _selectAll;
    List<PermissionTreeItemVm> _permissionTrees = [];

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var result = await PermissionAppService.GetAsync(ProviderName, ProviderKey);

        _groups = result.Groups;

        _selectAllDisabled = _groups.All(IsPermissionGroupDisabled);

        _grantedPermissionCount = 0;
        _notGrantedPermissionCount = 0;
        foreach (var permission in _groups.SelectMany(x => x.Permissions))
        {
            if (permission.IsGranted && permission.GrantedProviders.All(x => x.ProviderName != ProviderName))
            {
                _disabledPermissions.Add(permission);
                continue;
            }

            if (permission.IsGranted)
            {
                _grantedPermissionCount++;
            }
            else
            {
                _notGrantedPermissionCount++;
            }
        }

        foreach (var group in _groups)
        {
            _permissionTrees.AddRange(GenerateTree(group.Permissions, group.Name, null, 0, null));
        }
    }

    bool IsPermissionGroupDisabled(PermissionGroupDto group)
    {
        var permissions = group.Permissions;
        var grantedProviders = permissions.SelectMany(x => x.GrantedProviders);

        return permissions.All(x => x.IsGranted) && grantedProviders.Any(p => p.ProviderName != ProviderName);
    }

    List<PermissionTreeItemVm> GenerateTree(List<PermissionGrantInfoDto> allPermissions, string groupName, string? parentName, int depth, PermissionTreeItemVm? parent)
    {
        var treeItems = new List<PermissionTreeItemVm>();
        var subPermissions = allPermissions.Where(p => p.ParentName == parentName);

        foreach (var item in subPermissions)
        {
            var treeItem = new PermissionTreeItemVm(groupName, depth, item);
            treeItem.SetParent(parent);
            treeItem.Children = GenerateTree(allPermissions, groupName, item.Name, depth + 1, treeItem);
            treeItems.Add(treeItem);
        }
        return treeItems;
    }

    bool IsDisabledPermission(PermissionGrantInfoDto permissionGrantInfo)
    {
        return _disabledPermissions.Any(x => x == permissionGrantInfo);
    }

    void PermissionCheckChanged(object obj)
    {
        var treeItem = (PermissionTreeItemVm)obj;

        if (treeItem.IsGranted)
        {
            // 选中所有直接父节点
            GrantAllDirectParents(treeItem);
        }
        else
        {
            // 取消所有子节点
            GrantAllChildren(treeItem, false);
        }

        StateHasChanged();
    }

    void GrantAllDirectParents(PermissionTreeItemVm treeItem)
    {
        var parentTreeItem = treeItem.Parent;
        while (parentTreeItem != null)
        {
            parentTreeItem.IsGranted = true;
            parentTreeItem = parentTreeItem.Parent;
            if (parentTreeItem == null)
            {
                break;
            }
        }
    }

    void GrantAllChildren(PermissionTreeItemVm treeItem, bool isGranted)
    {
        foreach (var child in treeItem.Children)
        {
            child.IsGranted = isGranted;
            GrantAllChildren(child, isGranted);
        }
    }

    void SelectAll(string groupName)
    {
        foreach (var item in _permissionTrees.Where(i => i.GroupName == groupName))
        {
            item.IsGranted = _selectAll;
            GrantAllChildren(item, _selectAll);
        }
    }

    async Task SaveAsync()
    {
        try
        {
            var updateDto = new UpdatePermissionsDto
                {
                    Permissions = GetAllTreeItemes(_permissionTrees).ToArray(),
                };

            if (!updateDto.Permissions.Any(x => x.IsGranted))
            {
                var result = await DialogService.Confirm("您确定要在没有任何权限的情况下保存吗？", "保存权限", 
                    new ConfirmOptions()
                        {
                            OkButtonText = "确定",
                            CancelButtonText = "取消"
                        });

                if (result == false)
                {
                    return;
                }
            }

            await PermissionAppService.UpdateAsync(ProviderName, ProviderKey, updateDto);
            await CacheResetService.ResetAsync();

            NotificationService.Success("保存成功");
        }
        catch (Exception ex)
        {
            NotificationService.Error(ex.Message);
        }
    }

    List<UpdatePermissionDto> GetAllTreeItemes(List<PermissionTreeItemVm> treeItems)
    {
        var result = new List<UpdatePermissionDto>();
        foreach (var item in treeItems)
        {
            result.Add(new UpdatePermissionDto
            {
                Name = item.Name,
                IsGranted = item.IsGranted
            });
            result.AddRange(GetAllTreeItemes(item.Children));
        }

        return result;
    }
}