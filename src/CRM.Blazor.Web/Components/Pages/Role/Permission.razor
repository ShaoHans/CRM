@using Volo.Abp.AspNetCore.Components.Web.Configuration
@using Volo.Abp.PermissionManagement
@inject IPermissionAppService PermissionAppService
@inject ICurrentApplicationConfigurationCacheResetService CacheResetService
@inject NotificationService NotificationService
@inject DialogService DialogService


<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
    <RadzenCheckBox TValue="bool" Name="GrantAll" Value="@(_groups.All(x=>x.GrantAll))" ValueChanged="GrantAll" />
    <RadzenLabel Text="授予所有权限" Component="GrantAll" />
</RadzenStack>
<RadzenStack Orientation="Orientation.Vertical" Gap="0" class="rz-pt-1"
             Style="border-top: var(--rz-grid-cell-border); min-height: 2rem; max-height: 12rem; overflow: auto;" />

<RadzenTabs TabPosition="TabPosition.Left" RenderMode="TabRenderMode.Client">
    <Tabs>
        @foreach (var item in _groups)
        {
            <RadzenTabsItem Text="@item.DisplayName">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                    <RadzenCheckBox TValue="bool" Name="@item.DisplayName" @bind-Value="@item.GrantAll" />
                    <RadzenLabel Text="全选" Component="@item.DisplayName" />
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Vertical" Gap="0" class="rz-pt-1" 
                            Style="border-top: var(--rz-grid-cell-border); min-height: 2rem; max-height: 12rem; overflow: auto;" />

                <RadzenTree Style="width: 100%; height: 100%"
                            Data=@item.TreeItems>
                    <RadzenTreeLevel Text="(i=>((PermissionTreeItemVm)i).Permission.DisplayName)"
                                     ChildrenProperty="Children"
                                     Expanded="(i=>true)"
                                     HasChildren="(i=>((PermissionTreeItemVm)i).Children.Count>0)">
                        <Template>
                            @{
                                var treeItem = (PermissionTreeItemVm)context.Value;
                                <RadzenCheckBox TValue="bool"
                                                Name="@treeItem.Permission.Name"
                                                Disabled="@_disabledPermissions.Exists(x=>x.Name==treeItem.Permission.Name)"
                                                onclick="@(()=>PermissionCheckChanged(context.Value))"
                                                @bind-Value="treeItem.Permission.IsGranted" />
                                <RadzenLabel Text="@context.Text" Component="@treeItem.Permission.Name" />
                            }
                        </Template>
                    </RadzenTreeLevel>
                </RadzenTree>
            </RadzenTabsItem>
        }
    </Tabs>
</RadzenTabs>

<RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="0.5rem" class="rz-pt-4 rz-pb-8">
    <RadzenButton Icon="save" Click="SaveAsync">保存</RadzenButton>
</RadzenStack>

@code {
    [Parameter]
    public string ProviderName { get; set; } = default!;
    [Parameter]
    public string ProviderKey { get; set; } = default!;

    List<PermissionGroupVm> _groups = [];
    List<PermissionGrantInfoDto> _disabledPermissions = [];

    int _grantedPermissionCount = 0;
    int _notGrantedPermissionCount = 0;
    bool _selectAllDisabled;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var result = await PermissionAppService.GetAsync(ProviderName, ProviderKey);

        //_groups = result.Groups;
        _grantedPermissionCount = 0;
        _notGrantedPermissionCount = 0;

        foreach (var group in result.Groups)
        {
            _groups.Add(new PermissionGroupVm
                {
                    Name = group.Name,
                    DisplayName = group.DisplayName,
                    TreeItems = GenerateTree(group.Permissions, null, 0, null)
                });
        }

        //_selectAllDisabled = _groups.All(IsPermissionGroupDisabled);

        foreach (var permission in result.Groups.SelectMany(x => x.Permissions))
        {
            if (permission.IsGranted && permission.GrantedProviders.All(x => x.ProviderName != ProviderName))
            {
                _disabledPermissions.Add(permission);
                continue;
            }

            if (permission.IsGranted)
            {
                _grantedPermissionCount++;
            }
            else
            {
                _notGrantedPermissionCount++;
            }
        }
    }

    bool IsPermissionGroupDisabled(PermissionGroupDto group)
    {
        var permissions = group.Permissions;
        var grantedProviders = permissions.SelectMany(x => x.GrantedProviders);

        return permissions.All(x => x.IsGranted) && grantedProviders.Any(p => p.ProviderName != ProviderName);
    }

    List<PermissionTreeItemVm> GenerateTree(List<PermissionGrantInfoDto> allPermissions, string? parentName, int depth, PermissionTreeItemVm? parent)
    {
        var treeItems = new List<PermissionTreeItemVm>();
        var subPermissions = allPermissions.Where(p => p.ParentName == parentName);

        foreach (var item in subPermissions)
        {
            var treeItem = new PermissionTreeItemVm(depth, item);
            treeItem.SetParent(parent);
            treeItem.Children = GenerateTree(allPermissions, item.Name, depth + 1, treeItem);
            treeItems.Add(treeItem);
        }
        return treeItems;
    }

    bool IsDisabledPermission(PermissionGrantInfoDto permissionGrantInfo)
    {
        return _disabledPermissions.Any(x => x == permissionGrantInfo);
    }

    void PermissionCheckChanged(object obj)
    {
        var treeItem = (PermissionTreeItemVm)obj;

        if (treeItem.Permission.IsGranted)
        {
            // 选中所有直接父节点
            GrantAllDirectParents(treeItem);
        }
        else
        {
            // 取消所有子节点
            GrantAllChildren(treeItem, false);
        }

        StateHasChanged();
    }

    void GrantAllDirectParents(PermissionTreeItemVm treeItem)
    {
        var parentTreeItem = treeItem.Parent;
        while (parentTreeItem != null)
        {
            parentTreeItem.Permission.IsGranted = true;
            parentTreeItem = parentTreeItem.Parent;
            if (parentTreeItem == null)
            {
                break;
            }
        }
    }

    void GrantAllChildren(PermissionTreeItemVm treeItem, bool isGranted)
    {
        foreach (var child in treeItem.Children)
        {
            child.Permission.IsGranted = isGranted;
            GrantAllChildren(child, isGranted);
        }
    }

    void GrantAll(bool isGranted)
    {
        foreach (var g in _groups)
        {
            g.Grant(isGranted);
        }
    }

    async Task SaveAsync()
    {
        try
        {
            var treeItems = new List<PermissionTreeItemVm>();
            _groups.ForEach(x => treeItems.AddRange(x.Expand()));
            var updateDto = new UpdatePermissionsDto
                {
                    Permissions = treeItems.Select(x => new UpdatePermissionDto
                    {
                        IsGranted = x.Permission.IsGranted,
                        Name = x.Permission.Name
                    }).ToArray()
                };

            if (!updateDto.Permissions.Any(x => x.IsGranted))
            {
                var result = await DialogService.Confirm("您确定要在没有任何权限的情况下保存吗？", "保存权限", 
                    new ConfirmOptions()
                        {
                            OkButtonText = "确定",
                            CancelButtonText = "取消"
                        });

                if (result == false)
                {
                    return;
                }
            }

            await PermissionAppService.UpdateAsync(ProviderName, ProviderKey, updateDto);
            await CacheResetService.ResetAsync();

            NotificationService.Success("保存成功");
        }
        catch (Exception ex)
        {
            NotificationService.Error(ex.Message);
        }
    }

}